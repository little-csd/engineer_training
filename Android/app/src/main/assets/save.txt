package com.example.aiins;

import androidx.annotation.RequiresApi;
import androidx.appcompat.app.AppCompatActivity;

import android.content.res.AssetManager;
import android.os.Build;
import android.os.Bundle;
import android.util.Log;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.FileReader;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.net.URL;
import java.net.URLClassLoader;
import java.nio.ByteBuffer;

import dalvik.system.BaseDexClassLoader;
import dalvik.system.DexClassLoader;
import dalvik.system.DexFile;
import dalvik.system.InMemoryDexClassLoader;

public class MainActivity extends AppCompatActivity {

    private static final String TAG = "MainActivity";

    @RequiresApi(api = Build.VERSION_CODES.O)
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        String path = getDataDir("test2.jar");
        Log.i(TAG, "onCreate: " + path);
        File file = new File(path);
        if (file.exists()) file.delete();
        byte[] ret = readAssetFile("test2.jar");
        Log.i(TAG, "onCreate: " + ret.length);
        writeFile(path, ret);
        assert file.exists();
//        Log.i(TAG, "onCreate: " + file.length());
//        Log.i(TAG, "onCreate: " + getDir("Hello", MODE_PRIVATE));
//        Log.i(TAG, "onCreate: " + System.getProperty("java.library.path"));

        try {
            ClassLoader cl = getClassLoader();
            if (cl instanceof BaseDexClassLoader) {
                Log.i(TAG, "onCreate: Base");
                BaseDexClassLoader bcl = (BaseDexClassLoader) cl;

            }
            DexClassLoader dcl = new DexClassLoader(path, getDataDir(""), null, null);
            dcl.loadClass("com.A");
//            URL url = dcl.getResource("res.png");
//            Log.i(TAG, "onCreate: " + url);
//            ByteBuffer bb = ByteBuffer.allocate(ret.length);
//            bb.put(ret);
//            bb.flip();
//            InMemoryDexClassLoader idcl = new InMemoryDexClassLoader(bb, ClassLoader.getSystemClassLoader());
//            idcl.loadClass("com.A");
            Log.i(TAG, "onCreate: OK");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public String getDataDir(String name) {
        String s1 = getApplicationContext().getFilesDir().getParent();
        return s1 + "/" + name;
    }

    public byte[] readAssetFile(String name) {
        InputStream in = null;
        byte[] ret = null;
        try {
            in = getAssets().open(name);
            ret = new byte[in.available()];
            in.read(ret);
        } catch (Exception e) {
            e.printStackTrace();
        }
        return ret;
    }

    public void writeFile(String path, byte[] data) {
        File file = new File(path);
        try {
            if (!file.exists()) {
                file.getParentFile().mkdirs();
                file.createNewFile();
            }
            FileOutputStream fos = new FileOutputStream(file);
            fos.write(data);
            fos.flush();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}